---
title: WeCom Commander-æ›´æ–°001-ç™»å½•é‰´æƒåŠŸèƒ½-å®ç°æ€»ç»“
type: update-summary
update_number: 1
category: 01-æ ¸å¿ƒåŠŸèƒ½
status: å·²å®Œæˆ
created: 2026-01-30
plan: "[[plan]]"
update: "[[update-001]]"
tags:
  - spec
  - update
  - summary
  - authentication
---

# æ›´æ–°æ€»ç»“ - ç™»å½•é‰´æƒåŠŸèƒ½

## æ–‡æ¡£ä¿¡æ¯

- **æ›´æ–°ç¼–å·**: update-001
- **åˆ›å»ºæ—¥æœŸ**: 2026-01-30
- **å¯¹åº”æ›´æ–°æ–‡æ¡£**: update-001.md
- **åŸ plan.md**: spec/01-æ ¸å¿ƒåŠŸèƒ½/wecom-cmder/plan.md
- **å®æ–½äººå‘˜**: Claude Code
- **å®æ–½æ—¶é—´**: çº¦ 2 å°æ—¶

---

## 1. æ›´æ–°å†…å®¹

### 1.1 æ›´æ–°ç›®æ ‡

ä¸º WeCom Commander æ·»åŠ å®Œæ•´çš„ç™»å½•é‰´æƒåŠŸèƒ½ï¼Œä¿æŠ¤ Web ç®¡ç†ç•Œé¢å’Œ API æ¥å£ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚

### 1.2 å®Œæˆçš„ä¿®æ”¹

**åç«¯å®ç°**ï¼š
- [x] å®‰è£…ä¾èµ–ï¼ˆpython-joseã€passlibï¼‰
- [x] åˆ›å»ºå®‰å…¨æ¨¡å—ï¼ˆbackend/app/core/security.pyï¼‰
- [x] åˆ›å»ºé…ç½®æ¨¡å—ï¼ˆbackend/app/core/config.pyï¼‰
- [x] åˆ›å»ºè®¤è¯ Schemasï¼ˆbackend/app/schemas/auth.pyï¼‰
- [x] åˆ›å»ºè®¤è¯ API æ¥å£ï¼ˆbackend/app/api/endpoints/auth.pyï¼‰
- [x] æ³¨å†Œè®¤è¯è·¯ç”±ï¼ˆbackend/app/api/router.pyï¼‰
- [x] ä¿æŠ¤ç°æœ‰ API æ¥å£ï¼ˆconfigã€messageã€commandï¼‰
- [x] åˆå§‹åŒ–ç”¨æˆ·é…ç½®ï¼ˆbackend/app/main.pyï¼‰

**å‰ç«¯å®ç°**ï¼š
- [x] åˆ›å»ºç™»å½•é¡µé¢ï¼ˆfrontend/src/views/Login.vueï¼‰
- [x] æ›´æ–° API å®¢æˆ·ç«¯ï¼ˆfrontend/src/api/client.tsï¼‰
- [x] æ·»åŠ è·¯ç”±å®ˆå«ï¼ˆfrontend/src/router/index.tsï¼‰
- [x] æ·»åŠ ç™»å‡ºåŠŸèƒ½ï¼ˆfrontend/src/App.vueï¼‰
- [x] æ›´æ–°ç±»å‹å®šä¹‰ï¼ˆfrontend/src/types/api.tsï¼‰

### 1.3 ä¿®æ”¹çš„æ–‡ä»¶

```
backend/
â”œâ”€â”€ requirements.txt                    # æ·»åŠ  JWT å’Œå¯†ç åŠ å¯†ä¾èµ–
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                         # æ·»åŠ ç”¨æˆ·é…ç½®åˆå§‹åŒ–
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ security.py                 # æ–°å¢ï¼šJWT å’Œå¯†ç åŠ å¯†
â”‚   â”‚   â””â”€â”€ config.py                   # æ–°å¢ï¼šç”¨æˆ·é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ auth.py                     # æ–°å¢ï¼šè®¤è¯ç›¸å…³ Schemas
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ router.py                   # æ³¨å†Œè®¤è¯è·¯ç”±
â”‚   â”‚   â””â”€â”€ endpoints/
â”‚   â”‚       â”œâ”€â”€ auth.py                 # æ–°å¢ï¼šç™»å½•æ¥å£
â”‚   â”‚       â”œâ”€â”€ config.py               # æ·»åŠ  Token éªŒè¯
â”‚   â”‚       â”œâ”€â”€ message.py              # æ·»åŠ  Token éªŒè¯
â”‚   â”‚       â””â”€â”€ command.py              # æ·»åŠ  Token éªŒè¯

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ api.ts                      # æ·»åŠ è®¤è¯ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ client.ts                   # æ·»åŠ ç™»å½•æ¥å£å’Œæ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ index.ts                    # æ·»åŠ ç™»å½•è·¯ç”±å’Œè·¯ç”±å®ˆå«
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ Login.vue                   # æ–°å¢ï¼šç™»å½•é¡µé¢
â”‚   â””â”€â”€ App.vue                         # æ·»åŠ ç™»å‡ºæŒ‰é’®å’Œè®¤è¯æ£€æŸ¥
```

---

## 2. æŠ€æœ¯å®ç°ç»†èŠ‚

### 2.1 è®¤è¯æ–¹æ¡ˆ

é‡‡ç”¨ **JWT (JSON Web Token)** è®¤è¯æ–¹æ¡ˆï¼š

- **Token ç”Ÿæˆ**ï¼šä½¿ç”¨ python-jose åº“ç”Ÿæˆ JWT Token
- **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨ passlib + bcrypt åŠ å¯†å¯†ç 
- **Token å­˜å‚¨**ï¼šå‰ç«¯ä½¿ç”¨ localStorage å­˜å‚¨
- **Token æœ‰æ•ˆæœŸ**ï¼š24 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- **Token ä¼ é€’**ï¼šHTTP Header `Authorization: Bearer <token>`

### 2.2 å•ç”¨æˆ·æ¨¡å¼

å®ç°äº†å•ç”¨æˆ·æ¨¡å¼çš„ç”¨æˆ·ç®¡ç†ï¼š

- **ç”¨æˆ·å­˜å‚¨**ï¼šé…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆå†…å­˜å­—å…¸ï¼‰
- **é»˜è®¤ç”¨æˆ·**ï¼šadmin / admin123
- **ç¯å¢ƒå˜é‡é…ç½®**ï¼š
  - `ADMIN_USERNAME`ï¼šç®¡ç†å‘˜ç”¨æˆ·å
  - `ADMIN_PASSWORD`ï¼šç®¡ç†å‘˜å¯†ç ï¼ˆæ˜æ–‡ï¼‰
  - `ADMIN_PASSWORD_HASH`ï¼šç®¡ç†å‘˜å¯†ç å“ˆå¸Œï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
  - `SECRET_KEY`ï¼šJWT å¯†é’¥
  - `ACCESS_TOKEN_EXPIRE_MINUTES`ï¼šToken è¿‡æœŸæ—¶é—´

### 2.3 API ä¿æŠ¤

æ‰€æœ‰ç®¡ç†æ¥å£éƒ½æ·»åŠ äº† Token éªŒè¯ï¼š

**éœ€è¦è®¤è¯çš„æ¥å£**ï¼š
- `GET /api/v1/config/wechat` - è·å–é…ç½®
- `PUT /api/v1/config/wechat` - æ›´æ–°é…ç½®
- `POST /api/v1/config/wechat/test` - æµ‹è¯•é…ç½®
- `POST /api/v1/messages/send` - å‘é€æ¶ˆæ¯
- `GET /api/v1/messages` - è·å–æ¶ˆæ¯å†å²
- `GET /api/v1/commands` - è·å–å‘½ä»¤åˆ—è¡¨
- `PUT /api/v1/commands/{id}` - æ›´æ–°å‘½ä»¤
- `POST /api/v1/commands/sync-menu` - åŒæ­¥èœå•

**ä¸éœ€è¦è®¤è¯çš„æ¥å£**ï¼š
- `GET /api/v1/wechat/callback` - ä¼ä¸šå¾®ä¿¡å›è°ƒï¼ˆURL éªŒè¯ï¼‰
- `POST /api/v1/wechat/callback` - ä¼ä¸šå¾®ä¿¡å›è°ƒï¼ˆæ¶ˆæ¯æ¥æ”¶ï¼‰
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /api/v1/auth/login` - ç™»å½•æ¥å£

### 2.4 å‰ç«¯è·¯ç”±å®ˆå«

å®ç°äº†å®Œæ•´çš„è·¯ç”±å®ˆå«æœºåˆ¶ï¼š

- **æœªç™»å½•ç”¨æˆ·**ï¼šè®¿é—®ä»»ä½•é¡µé¢éƒ½ä¼šé‡å®šå‘åˆ° `/login`
- **å·²ç™»å½•ç”¨æˆ·**ï¼šè®¿é—® `/login` ä¼šé‡å®šå‘åˆ°é¦–é¡µ `/`
- **Token è¿‡æœŸ**ï¼šAPI è¿”å› 401 æ—¶è‡ªåŠ¨æ¸…é™¤ Token å¹¶è·³è½¬åˆ°ç™»å½•é¡µ

### 2.5 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- **ç™»å½•é¡µé¢**ï¼šç¾è§‚çš„æ¸å˜èƒŒæ™¯ï¼ŒMaterial Design é£æ ¼
- **é”™è¯¯æç¤º**ï¼šç™»å½•å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **è‡ªåŠ¨ç™»å‡º**ï¼šToken è¿‡æœŸæ—¶è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- **ç™»å‡ºæŒ‰é’®**ï¼šå¯¼èˆªæ å³ä¸Šè§’æ˜¾ç¤ºç™»å‡ºæŒ‰é’®
- **å›è½¦ç™»å½•**ï¼šå¯†ç æ¡†æ”¯æŒå›è½¦é”®æäº¤

---

## 3. æµ‹è¯•ç»“æœ

### 3.1 åç«¯æµ‹è¯•

**å¯åŠ¨æµ‹è¯•**ï¼š
- âœ… åç«¯æˆåŠŸå¯åŠ¨
- âœ… ç”¨æˆ·é…ç½®åˆå§‹åŒ–æˆåŠŸ
- âœ… é»˜è®¤ç”¨æˆ· admin å·²åŠ è½½

**API æµ‹è¯•**ï¼š
- âœ… ç™»å½•æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… Token ç”ŸæˆæˆåŠŸ
- âœ… Token éªŒè¯æ­£å¸¸
- âœ… å—ä¿æŠ¤çš„ API éœ€è¦ Token
- âœ… ä¼ä¸šå¾®ä¿¡å›è°ƒæ¥å£ä¸å—å½±å“

### 3.2 å‰ç«¯æµ‹è¯•

**è·¯ç”±æµ‹è¯•**ï¼š
- âœ… æœªç™»å½•è®¿é—®é¦–é¡µè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- âœ… ç™»å½•æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ
- âœ… å·²ç™»å½•è®¿é—®ç™»å½•é¡µè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ

**åŠŸèƒ½æµ‹è¯•**ï¼š
- âœ… ç™»å½•è¡¨å•éªŒè¯æ­£å¸¸
- âœ… ç™»å½•æˆåŠŸå Token å­˜å‚¨åˆ° localStorage
- âœ… API è¯·æ±‚è‡ªåŠ¨æºå¸¦ Token
- âœ… ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### 3.3 å›å½’æµ‹è¯•

- âœ… ä¼ä¸šå¾®ä¿¡å›è°ƒæ¥å£æ­£å¸¸å·¥ä½œï¼ˆä¸å—é‰´æƒå½±å“ï¼‰
- âœ… å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… åŸæœ‰åŠŸèƒ½ï¼ˆé…ç½®ã€æ¶ˆæ¯ã€å‘½ä»¤ï¼‰æ­£å¸¸å·¥ä½œ

---

## 4. ä¸æ›´æ–°æ–¹æ¡ˆçš„å·®å¼‚

### 4.1 æŒ‰è®¡åˆ’å®Œæˆ

- [x] åç«¯ JWT è®¤è¯åŠŸèƒ½
- [x] å‰ç«¯ç™»å½•é¡µé¢
- [x] è·¯ç”±å®ˆå«
- [x] API é‰´æƒ
- [x] å•ç”¨æˆ·æ¨¡å¼

### 4.2 è°ƒæ•´é¡¹

1. **å¯†ç å¤„ç†ä¼˜åŒ–**
   - **åŸå› **ï¼šbcrypt å¯¹å¯†ç é•¿åº¦æœ‰ 72 å­—èŠ‚é™åˆ¶
   - **è°ƒæ•´**ï¼šåœ¨åŠ å¯†å’ŒéªŒè¯æ—¶æˆªæ–­å¯†ç ä¸º 72 å­—èŠ‚
   - **å½±å“**ï¼šæ— ï¼Œæ­£å¸¸å¯†ç ä¸ä¼šè¶…è¿‡æ­¤é™åˆ¶

2. **æ§åˆ¶å°è¾“å‡ºä¼˜åŒ–**
   - **åŸå› **ï¼šWindows æ§åˆ¶å°ä¸æ”¯æŒ Unicode å­—ç¬¦
   - **è°ƒæ•´**ï¼šå°† âœ“ å’Œ âš ï¸ æ”¹ä¸º [OK] å’Œ [WARNING]
   - **å½±å“**ï¼šæ— ï¼Œä»…å½±å“æ—¥å¿—æ˜¾ç¤º

3. **ä»£ç æ ¼å¼åŒ–**
   - **åŸå› **ï¼šLinter è‡ªåŠ¨æ ¼å¼åŒ–
   - **è°ƒæ•´**ï¼šéƒ¨åˆ†ä»£ç æ ¼å¼è°ƒæ•´ï¼ˆå¦‚ `_from` å‚æ•°é‡å‘½åï¼‰
   - **å½±å“**ï¼šæ— ï¼Œä»…ä»£ç é£æ ¼è°ƒæ•´

### 4.3 æœªå®Œæˆé¡¹

æ— ã€‚æ‰€æœ‰è®¡åˆ’åŠŸèƒ½å‡å·²å®ç°ã€‚

---

## 5. å®‰å…¨è€ƒè™‘

### 5.1 å·²å®ç°çš„å®‰å…¨æªæ–½

- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- âœ… JWT Token æœ‰è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
- âœ… Token åœ¨ HTTP Header ä¸­ä¼ é€’ï¼ˆä¸åœ¨ URL ä¸­ï¼‰
- âœ… ä¼ä¸šå¾®ä¿¡å›è°ƒæ¥å£ä¸å—é‰´æƒå½±å“
- âœ… å¥åº·æ£€æŸ¥æ¥å£ä¸å—é‰´æƒå½±å“

### 5.2 å®‰å…¨å»ºè®®

> [!warning] ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
> 1. **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼šå¿…é¡»ä¿®æ”¹é»˜è®¤çš„ admin/admin123
> 2. **ä½¿ç”¨å¼ºå¯†é’¥**ï¼šSECRET_KEY å¿…é¡»ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
> 3. **ä½¿ç”¨ HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS éƒ¨ç½²
> 4. **ç¯å¢ƒå˜é‡**ï¼šæ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼Œä¸è¦ç¡¬ç¼–ç 

### 5.3 ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹

```bash
# .env æ–‡ä»¶
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-strong-password-here
SECRET_KEY=your-secret-key-change-this-in-production-please-use-strong-random-string
ACCESS_TOKEN_EXPIRE_MINUTES=1440
```

---

## 6. éƒ¨ç½²è¯´æ˜

### 6.1 Docker Compose éƒ¨ç½²

éœ€è¦åœ¨ `docker-compose.yml` ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```yaml
services:
  backend:
    environment:
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440
```

### 6.2 é¦–æ¬¡ç™»å½•

1. å¯åŠ¨æœåŠ¡åï¼Œè®¿é—® `http://localhost:3000`
2. è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
3. ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin123`ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹ï¼‰
4. ç™»å½•æˆåŠŸåè¿›å…¥ç®¡ç†ç•Œé¢

---

## 7. åç»­ä¼˜åŒ–æ–¹å‘

### 7.1 çŸ­æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

- [ ] å®ç° Refresh Token æœºåˆ¶ï¼ˆå»¶é•¿ç™»å½•æ—¶é—´ï¼‰
- [ ] å®ç°"è®°ä½æˆ‘"åŠŸèƒ½
- [ ] æ·»åŠ ç™»å½•æ—¥å¿—è®°å½•
- [ ] æ·»åŠ å¯†ç ä¿®æ”¹åŠŸèƒ½
- [ ] æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯

### 7.2 é•¿æœŸæ‰©å±•ï¼ˆå¯é€‰ï¼‰

- [ ] å°†ç”¨æˆ·ä¿¡æ¯è¿ç§»åˆ°æ•°æ®åº“
- [ ] å®ç°å¤šç”¨æˆ·ç®¡ç†
- [ ] å®ç°ç”¨æˆ·æƒé™ç³»ç»Ÿï¼ˆRBACï¼‰
- [ ] å®ç°å¯†ç æ‰¾å›åŠŸèƒ½
- [ ] å®ç°å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
- [ ] é›†æˆä¼ä¸šå¾®ä¿¡ OAuth ç™»å½•

---

## 8. æ–‡æ¡£å…³è”

- æ›´æ–°æ–¹æ¡ˆ: [[update-001|æ›´æ–°æ–¹æ¡ˆ]]
- åŸè®¾è®¡: [[plan|è®¾è®¡æ–¹æ¡ˆ]]
- åŸæ€»ç»“: [[summary|å®ç°æ€»ç»“]]
- å®¡æŸ¥æŠ¥å‘Š: [[update-001-review|å®¡æŸ¥æŠ¥å‘Š]] (å¾…ç”Ÿæˆ)

---

## 9. å‚è€ƒèµ„æ–™

- åŸ plan.md: spec/01-æ ¸å¿ƒåŠŸèƒ½/wecom-cmder/plan.md
- æ›´æ–°æ–‡æ¡£: update-001.md
- JWT æ–‡æ¡£: https://jwt.io/
- FastAPI å®‰å…¨æ–‡æ¡£: https://fastapi.tiangolo.com/tutorial/security/
- Vue Router å¯¼èˆªå®ˆå«: https://router.vuejs.org/guide/advanced/navigation-guards.html

---

**æ€»ç»“**:

âœ… **æ›´æ–°å·²å…¨éƒ¨å®Œæˆï¼**

æˆåŠŸä¸º WeCom Commander æ·»åŠ äº†å®Œæ•´çš„ç™»å½•é‰´æƒåŠŸèƒ½ï¼š

**åç«¯ï¼ˆ100%ï¼‰**
- âœ… JWT Token ç”Ÿæˆå’ŒéªŒè¯
- âœ… å¯†ç åŠ å¯†å­˜å‚¨
- âœ… API é‰´æƒä¸­é—´ä»¶
- âœ… å•ç”¨æˆ·æ¨¡å¼é…ç½®

**å‰ç«¯ï¼ˆ100%ï¼‰**
- âœ… ç™»å½•é¡µé¢
- âœ… è·¯ç”±å®ˆå«
- âœ… Token ç®¡ç†
- âœ… è‡ªåŠ¨ç™»å‡º

**å®‰å…¨æ€§ï¼ˆ100%ï¼‰**
- âœ… æ‰€æœ‰ç®¡ç†æ¥å£å—ä¿æŠ¤
- âœ… ä¼ä¸šå¾®ä¿¡å›è°ƒä¸å—å½±å“
- âœ… Token è¿‡æœŸè‡ªåŠ¨å¤„ç†
- âœ… ç¯å¢ƒå˜é‡é…ç½®æ”¯æŒ

ä»£ç è´¨é‡è‰¯å¥½ï¼Œä¸¥æ ¼éµå¾ª update-001.md çš„è®¾è®¡æ–¹æ¡ˆï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œæµ‹è¯•é€šè¿‡ã€‚

**å½“å‰çŠ¶æ€**: ğŸš€ å·²å®Œæˆï¼Œå¯ä»¥ç«‹å³ä½¿ç”¨ï¼

**é»˜è®¤ç™»å½•ä¿¡æ¯**:
- ç”¨æˆ·åï¼š`admin`
- å¯†ç ï¼š`admin123`

âš ï¸ **é‡è¦æé†’**ï¼šç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç å’Œ SECRET_KEYï¼
